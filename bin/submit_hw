#!/usr/bin/env ruby
require 'json'
require 'colorize'
require 'pry'

# TODO (phlco) remove Hub dependency and use github gem/api directly

# TODO (phlco) we could move this to installfest too
unless ENV['HUMAN_NAME']
  puts "Please enter your full name (first and last)" # we could say lowercase here.
  human_name = gets.chomp.strip.downcase.gsub(' ', '_')
  system("export HUMAN_NAME=#{human_name}")
  system("echo '\nexport HUMAN_NAME=#{human_name}\n' >> ~/.bash_profile")
end

data = {}

print "\nHow many parts of the homework did you finish? "
data["completeness"] = gets

begin
  data["completeness"] = Integer(data["completeness"])
  raise ArgumentError if data["completeness"] < 0
rescue ArgumentError
  puts "Invalid: not an integer (0 or greater)".red
  exit(false)
end

print "Comfortability [1 - 3]? "
data["comfortability"] = gets.gsub(/\W+/, '').to_i

unless (1..5).member?(data["comfortability"])
  puts "Invalid numbers (only 1 - 3)".red
  exit(false)
end

# github_name  = `git config --get user.name`.strip
github_name = ENV['HUMAN_NAME'] || human_name

puts "Pushing your work to your fork.\n".green
`git push origin master`

begin
  upstream = `git config --get remote.upstream.url`.strip.match(/:(.*)\.git/).captures.first
rescue NoMethodError
  # Upstream has not been set
  puts "You haven't configured a remote that points to the upstream repository!".red
  puts "Run the following then try again:"
  puts " $ git remote add upstream CLASS_REPO_SSH_URL"
  exit(false)
end

branch       = "#{upstream}:#{github_name}"
submitted_at = Time.now.strftime('%Y-%m-%d')
submission   = `hub pull-request -m $'HW #{submitted_at}\n\n#{data.to_json}' -b '#{branch}' 2>&1` # print to STDOUT

if submission.include? "pull request already exists"
  puts "You already have an outstanding pull request which the instructors have yet to merge! Have a great day.".yellow
elsif submission.include? "Error creating pull request: Internal Server Error (HTTP 500)"
  puts "We may not have an upstream branch for you yet. Contact your Instructors!".yellow
elsif submission.include? "No commits between"
  # NOTE: (phlco) we'll ignore this for now becuase we probably won't get this error.
  puts "You haven't commited any changes.".red
else
  puts "Thanks for submitting your homework.".green
end
